/*
* TDI
* Version: 1.3.3
*/

if(typeof jQuery=="undefined"){throw ("Missing dependency: jQuery!");}(function($){var _TDI={_jQueryMinVersion:"1.5",_init:function(){_TDI._checkDependencies();},_checkDependencies:function(){var jQueryMinVersion=_TDI._jQueryMinVersion,versions={min:jQueryMinVersion.replace(/\./g,""),orig:jQuery.fn.jquery.replace(/\./g,"")},i;for(i=0,l=Math.max(versions.min.length,versions.orig.length);i<l;i++){versions.min+=(versions.min.charAt(i))?"":"0";versions.orig+=(versions.orig.charAt(i))?"":"0";}if(versions.orig<versions.min){throw ("TDI requires jQuery version "+jQueryMinVersion+" or higher!");}},_public:{}};window.TDI=_TDI._public;$(document).ready(_TDI._init);}(jQuery));(function($){var _TOOLS={_public:{getScript:function(url,options){var loaded=false,node;if(url){options=options||{};node=document.createElement("script");node.type="text/javascript";node.src=url;if(options.id){node.id=options.id;}if(options.complete){node.onreadystatechange=function(){var rs=this.readyState;if(!loaded&&(rs==="loaded"||rs==="complete")){loaded=true;node.onreadystatechange=null;options.complete(node);}};node.onload=function(){if(!loaded){loaded=true;options.complete(node);}};}document.getElementsByTagName("head")[0].appendChild(node);}},getStyle:function(url,options){var node;if(url){options=options||{};node=document.createElement("link");node.rel="stylesheet";node.type="text/css";node.media=options.media||"screen";node.href=url;if(options.id){node.id=options.id;}document.getElementsByTagName("head")[0].appendChild(node);options.complete&&options.complete(node);}}}};window.TDI.Tools=_TOOLS._public;}(jQuery));(function($){var _AJAX={_delegateSelectors:{linkClick:"a.ajaxlink, a.tdi",formSubmit:"form.ajaxform, form.tdi",formButtonActivate:"form.ajaxform input[type=submit], form.tdi input[type=submit], form.ajaxform button, form.tdi button",fieldChange:"select.ajaxselect, select.tdi, input.tdi"},_init:function(){_AJAX._bindUI();},_bindUI:function(){$(document).delegate(_AJAX._delegateSelectors.linkClick,"click",_AJAX._onLinkClick).delegate(_AJAX._delegateSelectors.formSubmit,"submit",_AJAX._onBeforeFormSubmit).delegate(_AJAX._delegateSelectors.formButtonActivate,"click",_AJAX._onFormButtonActivate).delegate(_AJAX._delegateSelectors.fieldChange,"change",_AJAX._onFieldChange);$(window).unload(_AJAX._unbindUI);$.event.special["tdi:ajax:beforeFormSubmit"]={_default:_AJAX._onFormSubmit};},_unbindUI:function(evt){$(document).undelegate(_AJAX._delegateSelectors.linkClick,"click",_AJAX._onLinkClick).undelegate(_AJAX._delegateSelectors.formSubmit,"submit",_AJAX._onBeforeFormSubmit).undelegate(_AJAX._delegateSelectors.formButtonActivate,"click",_AJAX._onFormButtonActivate).undelegate(_AJAX._delegateSelectors.fieldChange,"change",_AJAX._onFieldChange);},_onLinkClick:function(evt){evt.preventDefault();TDI.Ajax.send(this);},_onBeforeFormSubmit:function(evt){evt.preventDefault();$(this).trigger("tdi:ajax:beforeFormSubmit",{form:$(this)});},_onFormSubmit:function(evt){TDI.Ajax.send(evt.target);},_onFormButtonActivate:function(evt){var button=$(this),form=$(this.form);form.data("_submitButton",button);form.find("input.submit-action").remove();$("<input>").attr("type","hidden").attr("name",button.attr("name")).attr("value",button.attr("value")).addClass("submit-action").appendTo(form);},_onFieldChange:function(evt){TDI.Ajax.send($(this).data("ajax-url")?this:this.form);},_public:{send:function(elm,callbacks){callbacks=callbacks||{};var $elm=$(elm),name=$elm.attr("name"),value=$elm.val(),confirm=$elm.data("confirm"),related=$elm.closest($elm.data("related-ancestor")||"").add($($elm.data("related-element")||"")).add($($elm.attr("rel")||"")),url=$elm.data("ajax-url")||$elm.attr("href"),data={};if(name&&value){data[name]=value;}if((confirm&&!window.confirm(confirm))||$elm.is("[disabled], .disabled")){return false;}var _options={beforeStart:function(){var res=callbacks.beforeStart&&callbacks.beforeStart.apply(this,arguments);if(typeof res==="undefined"||res===true){$elm.add(related).addClass("loading");related.get(0)&&related.addClass("loading-target");callbacks.start&&callbacks.start.apply(this,arguments);return true;}return false;},beforeEnd:function(){var res=callbacks.beforeEnd&&callbacks.beforeEnd.apply(this,arguments);if(typeof res==="undefined"||res===true){$elm.add(related).removeClass("loading");related.get(0)&&related.removeClass("loading-target");callbacks.end&&callbacks.end.apply(this,arguments);}},data:data};if($elm.is("form")){TDI.Ajax.Request.sendForm($elm[0],_options);}else{TDI.Ajax.Request.send(url,_options);}}}};TDI.Ajax=_AJAX._public;TDI.Ajax.Request={send:function(url,options){options=options||{};options.url=TDI.Ajax.Request.ajaxifyUrl(url);$.ajax({url:options.url,type:options.method||"GET",data:options.data||"",dataType:"xml",beforeSend:function(xhr,settings){var res=options.beforeStart&&options.beforeStart(xhr,settings,options);if(typeof res==="undefined"||res===true){Response._start(xhr,settings,options);options.start&&options.start(xhr,settings,options);return true;}return false;},success:function(data,textStatus,xhr){Response._success(data,textStatus,xhr,options);},error:function(xhr,textStatus,error){Response._error(xhr,textStatus,error,options);},complete:function(xhr,textStatus){var res=options.beforeEnd&&options.beforeEnd(xhr,textStatus,options);if(typeof res==="undefined"||res===true){Response._end(xhr,textStatus,options);options.end&&options.end(xhr,textStatus,options);}}});},sendForm:function(form,options){options=options||{};var $form=$(form),$submitButton=$form.data("_submitButton"),url=$form.data("ajax-url")||$form.attr("action");options.url=TDI.Ajax.Request.ajaxifyUrl(url);var res=options.beforeStart&&options.beforeStart($form,options);if(res===false){return false;}options.start&&options.start($form,options);if($submitButton){$submitButton.addClass("loading");}var iframe=$("<iframe></iframe>");iframe.attr("name","form_iframe_"+(new Date()).getTime());iframe.css("display","none");iframe.appendTo(document.body);iframe.load(function(){var xml=this.contentWindow.document.XMLDocument||this.contentWindow.document;var res=options.beforeEnd&&options.beforeEnd($form,options,xml);if(res===false){return false;}Response._success(xml,"",null,options);options.end&&options.end($form,options,xml);if($submitButton){$submitButton.removeClass("loading");}setTimeout(function(){iframe.unbind().remove();},100);});$form.attr("action",options.url);$form.attr("method","post");if($form.find("input[type=file]").length>0){$form.attr("enctype","multipart/form-data");}else{$form.attr("enctype","application/x-www-form-urlencoded");}$form.attr("target",iframe.attr("name"));$form.data("isAjaxReady",true);$form[0].submit();},ajaxifyUrl:function(url){var p="_infuse=1";if(url.indexOf(p)>=0){return url;}if(url.indexOf("?#")>0){return url.replace(/\?#/,"?"+p+"#");}else{if(url.indexOf("&#")>0){return url.replace(/&#/,"&"+p+"#");}else{if(url.indexOf("?")>0){return url.replace(/\?/,"?"+p+"&");}else{if(url.indexOf("#")>0){return url.replace(/#/,"?"+p+"#");}else{return url+"?"+p;}}}}}};var Response={_scriptTags:[],_responses:{updates:[],inserts:[],scripts:[],styles:[],popups:[]},_start:function(xhr,settings,options){},_success:function(xml,textStatus,xhr,options){if(!xml){Response._error(xhr,textStatus,null,options);return false;}var $xml=$(xml),status=$xml.find("status");if(status.text().toLowerCase()!="ok"){Response._error(xhr,textStatus,status.text(),options);}$xml.find("*").each(function(){var tagName=this.tagName.toLowerCase();switch(this.tagName.toLowerCase()){case"update":Response._onBeforeUpdate(this);break;case"insert":Response._onBeforeInsert(this);break;case"script":Response._scriptTags.push(this);break;case"style":Response._onBeforeStyle(this);break;case"reload":Response._onBeforeReload(this);break;case"redirect":Response._onBeforeRedirect(this);break;case"popup":Response._onBeforePopup(this);break;}});Response._onBeforeScript(Response._scriptTags.shift());$(document).trigger("tdi:ajax:updatesDone",[{updates:Response._responses.updates}]);$(document).trigger("tdi:ajax:insertsDone",[{inserts:Response._responses.inserts}]);$(document).trigger("tdi:ajax:scriptsDone",[{scripts:Response._responses.scripts}]);$(document).trigger("tdi:ajax:stylesDone",[{styles:Response._responses.styles}]);$(document).trigger("tdi:ajax:popupsDone",[{popups:Response._responses.popups}]);$(document).trigger("tdi:ajax:done",[{options:options,responses:Response._responses}]);},_error:function(xhr,textStatus,error,options){$(document).trigger("tdi:ajax:error",[{status:xhr?xhr.status:"N/A",message:error||"Invalid Ajax response. The response must be a valid XML."}]);},_end:function(xhr,textStatus,options){},_onBeforeUpdate:function(tag){if(!tag){return false;}var $tag=$(tag),target_id=$tag.attr("target"),target=$("#"+$tag.attr("target")),content=$.trim($tag.text()),replace=$tag.attr("replace"),append=$tag.attr("append"),prepend=$tag.attr("prepend"),class_add=$tag.attr("class-add")||"",class_remove=$tag.attr("class-remove")||"",event_data={target_id:target_id,target:target,content:content,content_empty:(content.replace(/\&nbsp;/g,"").length===0),replace:replace,append:append,prepend:prepend,class_add:class_add,class_remove:class_remove};if(target.get(0)){target.trigger("tdi:ajax:beforeUpdate",event_data);Response._responses.updates.push(event_data);}},_onBeforeInsert:function(tag){if(!tag){return false;}var $tag=$(tag),target_id=$tag.attr("target"),target=$("#"+target_id),content=$.trim($tag.text()),position=$tag.attr("position")||"after",inserted_node,event_data={target_id:target_id,target:target,content:content,position:position,inserted_node:inserted_node};if(target.get(0)){target.trigger("tdi:ajax:beforeInsert",event_data);Response._responses.inserts.push(event_data);}},_onBeforeScript:function(tag){if(!tag){return false;}var $tag=$(tag),contents=$.trim($tag.text()),src=$tag.attr("src"),id=$tag.attr("id"),event_data={script_src:src,script_data:contents,script_id:id};$(document).trigger("tdi:ajax:beforeScript",event_data);Response._responses.scripts.push(event_data);},_onBeforeStyle:function(tag){if(!tag){return false;}var $tag=$(tag),src=$tag.attr("src"),id=$tag.attr("id"),event_data={style_src:src,style_id:id};$(document).trigger("tdi:ajax:beforeStyle",event_data);Response._responses.styles.push(event_data);},_onBeforeReload:function(){$(document).trigger("tdi:ajax:beforeReload",{});},_onBeforeRedirect:function(tag){if(!tag){return false;}var $tag=$(tag),href=$tag.attr("href");if(href){$(document).trigger("tdi:ajax:beforeRedirect",{href:href});}},_onBeforePopup:function(tag){if(!tag){return false;}var $tag=$(tag),mode=$tag.attr("mode")||"popup",href=$tag.attr("href"),width=$tag.attr("width")||600,height=$tag.attr("height")||500,event_data={href:href,mode:mode,width:parseInt(width),height:parseInt(height)};if(href){$(document).trigger("tdi:ajax:beforePopup",event_data);Response._responses.popups.push(event_data);}},_onUpdateDefault:function(evt,data){data.target.removeClass(data.class_remove).addClass(data.class_add);if(data.replace==="true"){data.target.find("*").andSelf().unbind();data.target.replaceWith(data.content);}else{if(data.append==="true"){data.target.append(data.content);}else{if(data.prepend==="true"){data.target.prepend(data.content);}else{data.target.find("*").unbind();data.target.html(data.content);}}}data.target.trigger("tdi:ajax:update",data);},_onInsertDefault:function(evt,data){data.inserted_node=$(data.content)[(data.position==="before")?"insertBefore":"insertAfter"](data.target);data.target.trigger("tdi:ajax:insert",data);},_onScriptDefault:function(evt,data){var scripts=Response._scriptTags,download=true,onComplete=function(node){var s;if(data.script_data){s=document.createElement("script");s.type="text/javascript";s.text=data.script_data;if(data.script_id){s.id=data.script_id+"_inline";}document.getElementsByTagName("head")[0].appendChild(s);}data.script_node=node;$(document).trigger("tdi:ajax:script",data);Response._onBeforeScript(scripts.shift());};if(data.script_src){if(data.script_id&&$("#"+data.script_id).length>0){download=false;}if(download){TDI.Tools.getScript(data.script_src,{id:data.script_id,complete:onComplete});}}else{onComplete();}},_onStyleDefault:function(evt,data){var download=true;if(data.style_id&&$("#"+data.style_id).length>0){download=false;}if(download){TDI.Tools.getStyle(data.style_src,{id:data.style_id,complete:function(node){data.style_node=node;$(document).trigger("tdi:ajax:style",data);}});}},_onReloadDefault:function(evt,data){window.location.reload(true);},_onRedirectDefault:function(evt,data){window.location.assign(data.href);},_onPopupDefault:function(evt,data){var params="",popup;if(data.mode==="dialog"){params+="width="+data.width+", height="+data.height;}data.popup=window.open(data.href,"_blank",params);$(document).trigger("tdi:ajax:popup",data);}};var i,customHandlers={"tdi:ajax:beforeUpdate":"_onUpdateDefault","tdi:ajax:beforeInsert":"_onInsertDefault","tdi:ajax:beforeScript":"_onScriptDefault","tdi:ajax:beforeStyle":"_onStyleDefault","tdi:ajax:beforeReload":"_onReloadDefault","tdi:ajax:beforeRedirect":"_onRedirectDefault","tdi:ajax:beforePopup":"_onPopupDefault"},customDefault=function(evt,data){Response[customHandlers[evt.type]](evt,data[1]);};for(i in customHandlers){$.event.special[i]={_default:customDefault};}_AJAX._init();}(jQuery));
